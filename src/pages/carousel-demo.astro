---
import "../styles/home.css";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <title>Carousel Coverflow Demo</title>
    <style>
      body {
        overflow-x: hidden;
        margin: 0;
        padding: 0;
        background: #fafdff;
      }

      #sandbox {
        align-items: stretch;
        justify-content: stretch;
        min-height: 100vh;
        display: flex;
      }

      .coverflow-carousel {
        width: 350px;
        height: 350px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .coverflow-item {
        width: 350px;
        height: 350px;
        object-fit: cover;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        will-change: transform, opacity;
      }

      @media (max-width: 600px) {
        .coverflow-carousel {
          width: 250px;
          height: 250px;
        }
        .coverflow-item {
          width: 250px;
          height: 250px;
        }
      }

      .mask {
        mask-image: linear-gradient(
          to right,
          transparent 10%,
          black 25%,
          black 75%,
          transparent 90%
        );
        -webkit-mask-image: linear-gradient(
          to right,
          transparent 10%,
          black 25%,
          black 75%,
          transparent 90%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
      }
    </style>
  </head>
  <body>
    <main id="sandbox">
      <div class="mask">
        <div
          role="region"
          aria-roledescription="carousel"
          class="coverflow-carousel"
          draggable="false"
          style="display:flex;position:relative;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;touch-action:pan-y"
        >
          <ul
            role="group"
            id="carousel-ul"
            style="display:flex;position:relative;list-style-type:none;padding:0;margin:0;justify-content:flex-start;flex-direction:row;gap:0px;align-items:center;width:100%;height:100%;max-height:100%;max-width:100%;"
          >
            <li
              class="ticker-item"
              aria-hidden="false"
              aria-posinset="1"
              aria-setsize="9"
              style="flex-grow:0;flex-shrink:0;position:relative;height:fit-content;z-index:1000;transform:none"
            >
              <img
                draggable="false"
                src="/photos/prague/image-01.jpg"
                alt="Photo 1"
                class="coverflow-item"
                style="transform:perspective(500px)"
              />
            </li>
            <li
              class="ticker-item"
              aria-hidden="false"
              aria-posinset="2"
              aria-setsize="9"
              style="flex-grow:0;flex-shrink:0;position:relative;height:fit-content;z-index:1000;transform:none"
            >
              <img
                draggable="false"
                src="/photos/prague/image-02.jpg"
                alt="Photo 2"
                class="coverflow-item"
                style="transform:perspective(500px)"
              />
            </li>
            <li
              class="ticker-item"
              aria-hidden="false"
              aria-posinset="3"
              aria-setsize="9"
              style="flex-grow:0;flex-shrink:0;position:relative;height:fit-content;z-index:1000;transform:none"
            >
              <img
                draggable="false"
                src="/photos/prague/image-03.jpg"
                alt="Photo 3"
                class="coverflow-item"
                style="transform:perspective(500px)"
              />
            </li>
            <li
              class="ticker-item"
              aria-hidden="false"
              aria-posinset="4"
              aria-setsize="9"
              style="flex-grow:0;flex-shrink:0;position:relative;height:fit-content;z-index:1000;transform:none"
            >
              <img
                draggable="false"
                src="/photos/prague/image-04.jpg"
                alt="Photo 4"
                class="coverflow-item"
                style="transform:perspective(500px)"
              />
            </li>
            <li
              class="ticker-item"
              aria-hidden="false"
              aria-posinset="5"
              aria-setsize="9"
              style="flex-grow:0;flex-shrink:0;position:relative;height:fit-content;z-index:1000;transform:none"
            >
              <img
                draggable="false"
                src="/photos/prague/image-05.jpg"
                alt="Photo 5"
                class="coverflow-item"
                style="transform:perspective(500px)"
              />
            </li>
            <li
              class="ticker-item"
              aria-hidden="false"
              aria-posinset="6"
              aria-setsize="9"
              style="flex-grow:0;flex-shrink:0;position:relative;height:fit-content;z-index:1000;transform:none"
            >
              <img
                draggable="false"
                src="/photos/prague/image-06.jpg"
                alt="Photo 6"
                class="coverflow-item"
                style="transform:perspective(500px)"
              />
            </li>
            <li
              class="ticker-item"
              aria-hidden="false"
              aria-posinset="7"
              aria-setsize="9"
              style="flex-grow:0;flex-shrink:0;position:relative;height:fit-content;z-index:1000;transform:none"
            >
              <img
                draggable="false"
                src="/photos/prague/image-07.jpg"
                alt="Photo 7"
                class="coverflow-item"
                style="transform:perspective(500px)"
              />
            </li>
            <li
              class="ticker-item"
              aria-hidden="false"
              aria-posinset="8"
              aria-setsize="9"
              style="flex-grow:0;flex-shrink:0;position:relative;height:fit-content;z-index:1000;transform:none"
            >
              <img
                draggable="false"
                src="/photos/prague/image-08.jpg"
                alt="Photo 8"
                class="coverflow-item"
                style="transform:perspective(500px)"
              />
            </li>
            <li
              class="ticker-item"
              aria-hidden="false"
              aria-posinset="9"
              aria-setsize="9"
              style="flex-grow:0;flex-shrink:0;position:relative;height:fit-content;z-index:1000;transform:none"
            >
              <img
                draggable="false"
                src="/photos/prague/image-09.jpg"
                alt="Photo 9"
                class="coverflow-item"
                style="transform:perspective(500px)"
              />
            </li>
          </ul>
        </div>
      </div>
    </main>

    <script>
      // 完全按照原示例代码实现
      // 原示例使用 Motion+ Carousel 的 useCarousel hook 提供 offset
      // offset 是每个 item 相对于容器中心的位置（像素值）

      const carouselUl = document.getElementById("carousel-ul");
      const carouselContainer = carouselUl?.parentElement;
      const items = carouselUl?.querySelectorAll(".ticker-item");
      const images = carouselUl?.querySelectorAll(".coverflow-item");

      if (!carouselUl || !carouselContainer || !items || !images) {
        console.error("Carousel elements not found");
      } else {
        const itemWidth = 350;
        const gap = 0;
        const totalItems = items.length;
        let currentX = 0;
        let isDragging = false;
        let startX = 0;
        let startScrollLeft = 0;
        let velocity = 0;
        let lastX = 0;
        let lastTime = 0;
        let animationFrameId = null;
        let dragDistance = 0; // 记录拖拽距离，用于区分点击和拖拽
        let clickedItemIndex = null; // 记录点击的 item 索引

        // 计算 offset（相对于容器中心的位置，像素值）
        // offset = itemCenterX - containerCenter
        // 原示例中，ul 通过 translateX 整体移动，每个 li 的初始位置是 itemIndex * (itemWidth + gap)
        function getOffset(itemIndex, scrollX) {
          if (!carouselContainer) return 0;
          const containerCenter = carouselContainer.offsetWidth / 2;
          // item 的初始位置（相对于 ul 的左边）
          const itemStart = itemIndex * (itemWidth + gap);
          // ul 的偏移量（scrollX，负值表示向左移动）
          // item 的实际位置 = itemStart + scrollX
          // item 的中心位置 = itemStart + scrollX + itemWidth / 2
          const itemCenterX = itemStart + scrollX + itemWidth / 2;
          // offset 是 item 中心相对于容器中心的距离
          return itemCenterX - containerCenter;
        }

        // 线性插值函数（useTransform 的实现）
        function lerp(input, inputRange, outputRange) {
          if (input <= inputRange[0]) return outputRange[0];
          if (input >= inputRange[inputRange.length - 1])
            return outputRange[outputRange.length - 1];

          // 找到 input 所在的区间
          for (let i = 0; i < inputRange.length - 1; i++) {
            if (input >= inputRange[i] && input <= inputRange[i + 1]) {
              const t =
                (input - inputRange[i]) / (inputRange[i + 1] - inputRange[i]);
              if (
                typeof outputRange[i] === "string" &&
                outputRange[i].includes("%")
              ) {
                // 百分比字符串需要特殊处理
                const start = parseFloat(outputRange[i]);
                const end = parseFloat(outputRange[i + 1]);
                return start + (end - start) * t + "%";
              }
              return outputRange[i] + (outputRange[i + 1] - outputRange[i]) * t;
            }
          }
          return outputRange[0];
        }

        // 根据 offset 计算 transform 值（完全按照原示例代码）
        function getTransformFromOffset(offset) {
          // rotateY: [-200, 0, 200] → [20, 0, -20]
          // 左侧图片向右旋转（正角度），右侧图片向左旋转（负角度）
          const rotateY = lerp(offset, [-200, 0, 200], [20, 0, -20]);

          // scale: [-200, 0, 200] → [0.7, 1, 0.7]
          // 中间图片 scale=1，左右图片 scale=0.7（压缩效果）
          const scale = lerp(offset, [-200, 0, 200], [0.7, 1, 0.7]);

          // x: [-800, -200, 200, 800] → ["100%", "0%", "0%", "-100%"]
          // 左侧图片向右偏移（正百分比），右侧图片向左偏移（负百分比）
          // 这是造成左右压缩方向不同的关键！
          const x = lerp(
            offset,
            [-800, -200, 200, 800],
            ["100%", "0%", "0%", "-100%"]
          );

          // zIndex: 基于 offset 绝对值计算
          // Math.max(0, Math.round(1000 - Math.abs(offset)))
          const zIndex = Math.max(0, Math.round(1000 - Math.abs(offset)));

          return { rotateY, scale, x, zIndex };
        }

        // 更新所有 item 的 transform
        function updateTransforms() {
          items.forEach((item, index) => {
            // 计算当前 item 的 offset
            const offset = getOffset(index, currentX);
            const { rotateY, scale, x, zIndex } =
              getTransformFromOffset(offset);

            // 更新 li 的 z-index
            item.style.zIndex = zIndex.toString();

            // 更新 img 的 transform
            const img = images[index];
            if (img) {
              // x 是百分比字符串，需要转换为像素值
              // 百分比是相对于 item 自身的宽度
              const xPx = x === "0%" ? 0 : (parseFloat(x) / 100) * itemWidth;

              // 按照原示例的 transform 顺序：perspective(500px) translateX(x) rotateY(deg) scale
              img.style.transform = `perspective(500px) translateX(${xPx}px) rotateY(${rotateY}deg) scale(${scale})`;
            }
          });
        }

        // 计算让指定 item 居中的 X 位置
        function getSnapPosition(itemIndex) {
          if (!carouselContainer) return 0;
          const containerCenter = carouselContainer.offsetWidth / 2;
          const itemStart = itemIndex * (itemWidth + gap);
          // 要让 item 居中，需要：itemStart + currentX + itemWidth/2 = containerCenter
          // 所以：currentX = containerCenter - itemStart - itemWidth/2
          return containerCenter - itemStart - itemWidth / 2;
        }

        // 找到距离当前位置最近的 item（用于 snap）
        function findNearestItem() {
          if (!carouselContainer) return 0;
          const containerCenter = carouselContainer.offsetWidth / 2;
          let nearestIndex = 0;
          let minDistance = Infinity;

          items.forEach((item, index) => {
            const itemStart = index * (itemWidth + gap);
            const itemCenterX = itemStart + currentX + itemWidth / 2;
            const distance = Math.abs(itemCenterX - containerCenter);
            if (distance < minDistance) {
              minDistance = distance;
              nearestIndex = index;
            }
          });

          return nearestIndex;
        }

        // 切换到指定索引的图片
        function goToItem(itemIndex) {
          const snapX = getSnapPosition(itemIndex);
          animateTo(snapX);
        }

        // 切换到下一张图片（往左滚动，显示下一张）
        function nextItem() {
          const currentIndex = findNearestItem();
          const nextIndex = (currentIndex + 1) % totalItems;
          goToItem(nextIndex);
        }

        // 切换到上一张图片（往右滚动，显示上一张）
        function prevItem() {
          const currentIndex = findNearestItem();
          const prevIndex = (currentIndex - 1 + totalItems) % totalItems;
          goToItem(prevIndex);
        }

        // 平滑动画到指定位置
        function animateTo(targetX, duration = 300) {
          const startX = currentX;
          const startTime = performance.now();

          function animate(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);

            // 使用 easeOutCubic 缓动函数
            const easeOutCubic = 1 - Math.pow(1 - progress, 3);
            currentX = startX + (targetX - startX) * easeOutCubic;

            updateCarouselPosition();

            if (progress < 1) {
              animationFrameId = requestAnimationFrame(animate);
            } else {
              animationFrameId = null;
            }
          }

          if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
          }
          animationFrameId = requestAnimationFrame(animate);
        }

        // 设置 ul 的 translateX（ul 整体移动）
        function updateCarouselPosition() {
          carouselUl.style.transform = `translateX(${currentX}px)`;
          updateTransforms();
        }

        // 拖拽功能
        carouselUl.addEventListener("mousedown", (e) => {
          // 找到点击的是哪个 item
          const clickedElement = e.target.closest(".ticker-item");
          if (clickedElement) {
            clickedItemIndex = Array.from(items).indexOf(clickedElement);
          } else {
            clickedItemIndex = null;
          }

          isDragging = true;
          startX = e.pageX;
          startScrollLeft = currentX;
          lastX = e.pageX;
          lastTime = performance.now();
          velocity = 0;
          dragDistance = 0; // 重置拖拽距离
          carouselUl.style.cursor = "grabbing";

          // 取消任何正在进行的动画
          if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
          }
        });

        carouselUl.addEventListener("mousemove", (e) => {
          if (!isDragging) return;
          e.preventDefault();
          const now = performance.now();
          const deltaTime = now - lastTime;
          const deltaX = e.pageX - lastX;

          // 计算速度（用于惯性滚动）
          if (deltaTime > 0) {
            velocity = deltaX / deltaTime;
          }

          const x = e.pageX - startX;
          dragDistance = Math.abs(x); // 记录拖拽距离
          currentX = startScrollLeft + x;
          updateCarouselPosition();

          lastX = e.pageX;
          lastTime = now;
        });

        carouselUl.addEventListener("mouseup", () => {
          if (isDragging) {
            isDragging = false;
            carouselUl.style.cursor = "grab";

            // 如果移动距离很小（小于5px），认为是点击而不是拖拽
            if (dragDistance < 5 && clickedItemIndex !== null) {
              // 这是点击，不是拖拽
              const offset = getOffset(clickedItemIndex, currentX);

              // 如果点击的是左侧的图片（offset < 0），往右滚动显示上一张（prevItem）
              // 如果点击的是右侧的图片（offset > 0），往左滚动显示下一张（nextItem）
              // 如果点击的是中间的图片（offset 接近 0），直接对齐
              if (offset < -50) {
                // 左侧，往右滚动显示上一张
                prevItem();
              } else if (offset > 50) {
                // 右侧，往左滚动显示下一张
                nextItem();
              } else {
                // 中间，直接对齐到这张
                goToItem(clickedItemIndex);
              }
            } else {
              // 这是拖拽，实现 snap：找到最近的 item 并平滑移动到中心
              const nearestIndex = findNearestItem();
              const snapX = getSnapPosition(nearestIndex);
              animateTo(snapX);
            }

            dragDistance = 0;
            clickedItemIndex = null;
          }
        });

        carouselUl.addEventListener("mouseleave", () => {
          if (isDragging) {
            isDragging = false;
            carouselUl.style.cursor = "grab";
          }
        });

        // 触摸支持
        carouselUl.addEventListener("touchstart", (e) => {
          isDragging = true;
          startX = e.touches[0].pageX;
          startScrollLeft = currentX;
          lastX = e.touches[0].pageX;
          lastTime = performance.now();
          velocity = 0;

          // 取消任何正在进行的动画
          if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
          }
        });

        carouselUl.addEventListener("touchmove", (e) => {
          if (!isDragging) return;
          const now = performance.now();
          const deltaTime = now - lastTime;
          const deltaX = e.touches[0].pageX - lastX;

          // 计算速度（用于惯性滚动）
          if (deltaTime > 0) {
            velocity = deltaX / deltaTime;
          }

          const x = e.touches[0].pageX - startX;
          currentX = startScrollLeft + x;
          updateCarouselPosition();

          lastX = e.touches[0].pageX;
          lastTime = now;
        });

        carouselUl.addEventListener("touchend", () => {
          if (isDragging) {
            isDragging = false;

            // 实现 snap：找到最近的 item 并平滑移动到中心
            const nearestIndex = findNearestItem();
            const snapX = getSnapPosition(nearestIndex);
            animateTo(snapX);
          }
        });

        carouselUl.style.cursor = "grab";

        // 给所有图片添加指针样式，提示可以点击
        images.forEach((img) => {
          img.style.cursor = "pointer";
        });

        // 初始化位置：让中间的图片（第5张，index=4）居中，这样左右各能看到2张图
        if (carouselContainer) {
          // 让中间的图片居中（总共9张，中间是第5张，index=4）
          const centerIndex = Math.floor(totalItems / 2); // 4
          currentX = getSnapPosition(centerIndex);
          updateCarouselPosition();
        }

        // 初始更新
        updateTransforms();
      }
    </script>
  </body>
</html>
